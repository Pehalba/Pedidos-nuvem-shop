{% extends "base.html" %} {% block title %}Todos os Pedidos - Gerenciador de
Pedidos{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">
      <h1 class="h3">
        <i class="fas fa-list-alt me-2"></i>
        Todos os Pedidos
      </h1>
      <div class="btn-group">
        <a href="{{ url_for('novo_pedido') }}" class="btn btn-primary">
          <i class="fas fa-plus me-1"></i>Novo Pedido
        </a>
        <a href="{{ url_for('exportar_csv') }}" class="btn btn-success">
          <i class="fas fa-download me-1"></i>Exportar CSV
        </a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-1"></i>Voltar
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Estat√≠sticas -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-primary">
          <i class="fas fa-box"></i>
        </h5>
        <h3 class="text-primary">{{ total_pedidos }}</h3>
        <p class="card-text">Total de Pedidos</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-info">
          <i class="fas fa-layer-group"></i>
        </h5>
        <h3 class="text-info">{{ pedidos_em_grupos }}</h3>
        <p class="card-text">Em Grupos</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-warning">
          <i class="fas fa-clock"></i>
        </h5>
        <h3 class="text-warning">{{ pedidos_sem_grupo }}</h3>
        <p class="card-text">Sem Grupo</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-success">
          <i class="fas fa-check-circle"></i>
        </h5>
        <h3 class="text-success">{{ grupos_enviados }}</h3>
        <p class="card-text">Grupos Enviados</p>
      </div>
    </div>
  </div>
</div>

<!-- Filtros -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-filter me-2"></i>
          Filtros e Visualiza√ß√£o
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="filtro"
                id="todos"
                checked
              />
              <label class="form-check-label" for="todos">
                <i class="fas fa-list me-1"></i>Todos ({{ total_pedidos }})
              </label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="filtro"
                id="padrao"
              />
              <label class="form-check-label" for="padrao">
                <i class="fas fa-shipping-fast me-1"></i>FRETE PADR√ÉO ({{
                pedidos_padrao|length }})
              </label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="filtro"
                id="expresso"
              />
              <label class="form-check-label" for="expresso">
                <i class="fas fa-shipping-fast me-1"></i>EXPRESSO ({{
                pedidos_expresso|length }})
              </label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="filtro"
                id="sem_grupo"
              />
              <label class="form-check-label" for="sem_grupo">
                <i class="fas fa-clock me-1"></i>Sem Grupo ({{ pedidos_sem_grupo
                }})
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- A√ß√µes em Lote -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-tasks me-2"></i>
          A√ß√µes em Lote
        </h6>
      </div>
      <div class="card-body">
        <form
          id="formAcoesLote"
          action="{{ url_for('acoes_lote') }}"
          method="POST"
        >
          <div class="row align-items-end">
            <div class="col-md-3">
              <label for="acao" class="form-label">A√ß√£o:</label>
              <select class="form-select" id="acao" name="acao" required>
                <option value="">Selecione uma a√ß√£o...</option>
                <option value="excluir">üóëÔ∏è Excluir Pedidos</option>
                <option value="remover_grupos">‚ùå Remover de Grupos</option>
                <option value="mover_grupo">üì¶ Mover para Grupo</option>
              </select>
            </div>
            <div class="col-md-4" id="grupoDestinoDiv" style="display: none">
              <label for="grupo_destino" class="form-label"
                >Grupo de Destino:</label
              >
              <select
                class="form-select"
                id="grupo_destino"
                name="grupo_destino"
              >
                <option value="">Selecione um grupo...</option>
                {% for grupo in grupos_disponiveis %}
                <option value="{{ grupo.id }}">
                  {{ grupo.nome }} ({{ grupo.total_pedidos }}/5 pedidos)
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <button
                type="submit"
                class="btn btn-warning"
                id="btnExecutarAcao"
                disabled
              >
                <i class="fas fa-play me-1"></i>Executar A√ß√£o
              </button>
            </div>
            <div class="col-md-2">
              <button
                type="button"
                class="btn btn-outline-secondary"
                id="btnSelecionarTodos"
              >
                <i class="fas fa-check-square me-1"></i>Selecionar Todos
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Lista de Todos os Pedidos -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-table me-2"></i>
          Lista Completa de Pedidos ({{ total_pedidos }})
        </h5>
      </div>
      <div class="card-body">
        {% if todos_pedidos %}
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th width="50">
                  <input
                    type="checkbox"
                    id="checkTodos"
                    class="form-check-input"
                  />
                </th>
                <th>ID</th>
                <th>Cliente</th>
                <th>Produto</th>
                <th>Tamanho</th>
                <th>Tipo Frete</th>
                <th>Grupo</th>
                <th>Status</th>
                <th>Data</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {% for pedido in todos_pedidos %}
              <tr
                class="pedido-row"
                data-tipo="{{ pedido.tipo_frete }}"
                data-grupo="{{ 'sem_grupo' if pedido.grupo_id is none else 'com_grupo' }}"
              >
                <td>
                  <input
                    type="checkbox"
                    name="pedidos_selecionados"
                    value="{{ pedido.id_pedido }}"
                    class="form-check-input check-pedido"
                  />
                </td>
                <td>
                  <strong>{{ pedido.id_pedido }}</strong>
                </td>
                <td>{{ pedido.nome_cliente }}</td>
                <td>{{ pedido.produto }}</td>
                <td>
                  <span class="badge bg-secondary">{{ pedido.tamanho }}</span>
                </td>
                <td>
                  {% if pedido.tipo_frete == 'FRETE PADR√ÉO' %}
                  <span class="badge bg-primary">
                    <i class="fas fa-shipping-fast me-1"></i>PADR√ÉO
                  </span>
                  {% else %}
                  <span class="badge bg-warning">
                    <i class="fas fa-shipping-fast me-1"></i>EXPRESSO
                  </span>
                  {% endif %}
                </td>
                <td>
                  {% if pedido.nome_grupo %}
                  <span class="badge bg-info">{{ pedido.nome_grupo }}</span>
                  {% else %}
                  <span class="badge bg-light text-dark">Sem Grupo</span>
                  {% endif %}
                </td>
                <td>
                  {% if pedido.grupo_enviado == 1 %}
                  <span class="badge bg-success">
                    <i class="fas fa-check me-1"></i>Enviado
                  </span>
                  {% elif pedido.grupo_id %}
                  <span class="badge bg-warning">
                    <i class="fas fa-clock me-1"></i>Pendente
                  </span>
                  {% else %}
                  <span class="badge bg-secondary">
                    <i class="fas fa-minus me-1"></i>N/A
                  </span>
                  {% endif %}
                </td>
                <td>
                  <small>{{ pedido.data_criacao[:10] }}</small>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <a
                      href="{{ url_for('editar_pedido', pedido_id=pedido.id_pedido) }}"
                      class="btn btn-outline-primary"
                      title="Editar"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                    {% if pedido.grupo_id %}
                    <a
                      href="{{ url_for('remover_pedido_grupo', grupo_id=pedido.grupo_id, pedido_id=pedido.id_pedido) }}"
                      class="btn btn-outline-warning"
                      title="Remover do Grupo"
                      onclick="return confirm('Remover pedido do grupo?')"
                    >
                      <i class="fas fa-times"></i>
                    </a>
                    {% endif %}
                                         <a
                       href="{{ url_for('excluir_pedido', pedido_id=pedido.id_pedido, next=request.path) }}"
                       class="btn btn-outline-danger"
                       title="Excluir"
                       onclick="return confirm('Excluir pedido {{ pedido.id_pedido }}?')"
                     >
                       <i class="fas fa-trash"></i>
                     </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Nenhum pedido encontrado</h5>
          <p class="text-muted">
            Crie seu primeiro pedido para come√ßar a usar o sistema.
          </p>
          <a href="{{ url_for('novo_pedido') }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Criar Primeiro Pedido
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Informa√ß√µes -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-info-circle me-2"></i>
          Informa√ß√µes sobre a Lista
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Funcionalidades:</h6>
            <ul>
              <li>Visualiza√ß√£o completa de todos os pedidos</li>
              <li>Filtros por tipo de frete e status</li>
              <li>Edi√ß√£o e exclus√£o direta</li>
              <li>Remo√ß√£o de pedidos de grupos</li>
              <li>Exporta√ß√£o para CSV</li>
              <li>
                <strong>üÜï A√ß√µes em Lote</strong> - Excluir, remover de grupos,
                mover para grupo
              </li>
              <li>
                <strong>üÜï Sele√ß√£o M√∫ltipla</strong> - Selecione v√°rios pedidos
                de uma vez
              </li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6>Legenda:</h6>
            <ul>
              <li>
                <span class="badge bg-primary">PADR√ÉO</span> - Frete padr√£o
                (pode ir para grupos)
              </li>
              <li>
                <span class="badge bg-warning">EXPRESSO</span> - Frete expresso
                (envio direto)
              </li>
              <li>
                <span class="badge bg-success">Enviado</span> - Grupo j√° foi
                enviado
              </li>
              <li>
                <span class="badge bg-warning">Pendente</span> - Grupo
                aguardando envio
              </li>
              <li>
                <span class="badge bg-secondary">N/A</span> - N√£o aplic√°vel
                (pedido sem grupo)
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Filtros JavaScript e A√ß√µes em Lote
  document.addEventListener("DOMContentLoaded", function () {
    const filtros = document.querySelectorAll('input[name="filtro"]');
    const linhas = document.querySelectorAll(".pedido-row");
    const checkTodos = document.getElementById("checkTodos");
    const checksPedidos = document.querySelectorAll(".check-pedido");
    const acaoSelect = document.getElementById("acao");
    const grupoDestinoDiv = document.getElementById("grupoDestinoDiv");
    const grupoDestinoSelect = document.getElementById("grupo_destino");
    const btnExecutarAcao = document.getElementById("btnExecutarAcao");
    const btnSelecionarTodos = document.getElementById("btnSelecionarTodos");
    const formAcoesLote = document.getElementById("formAcoesLote");

    // Filtros
    filtros.forEach((filtro) => {
      filtro.addEventListener("change", function () {
        const tipo = this.id;

        linhas.forEach((linha) => {
          let mostrar = false;

          switch (tipo) {
            case "todos":
              mostrar = true;
              break;
            case "padrao":
              mostrar = linha.dataset.tipo === "FRETE PADR√ÉO";
              break;
            case "expresso":
              mostrar = linha.dataset.tipo === "EXPRESSO";
              break;
            case "sem_grupo":
              mostrar = linha.dataset.grupo === "sem_grupo";
              break;
          }

          linha.style.display = mostrar ? "" : "none";
        });
      });
    });

    // Checkbox "Selecionar Todos"
    checkTodos.addEventListener("change", function () {
      const isChecked = this.checked;
      checksPedidos.forEach((check) => {
        if (check.closest("tr").style.display !== "none") {
          check.checked = isChecked;
        }
      });
      atualizarBotaoExecutar();
    });

    // Checkboxes individuais
    checksPedidos.forEach((check) => {
      check.addEventListener("change", function () {
        atualizarCheckTodos();
        atualizarBotaoExecutar();
      });
    });

    // Selecionar Todos (bot√£o)
    btnSelecionarTodos.addEventListener("click", function () {
      const pedidosVisiveis = Array.from(checksPedidos).filter(
        (check) => check.closest("tr").style.display !== "none"
      );

      if (pedidosVisiveis.some((check) => !check.checked)) {
        // Selecionar todos os vis√≠veis
        pedidosVisiveis.forEach((check) => (check.checked = true));
        btnSelecionarTodos.innerHTML =
          '<i class="fas fa-square me-1"></i>Desselecionar Todos';
      } else {
        // Desselecionar todos
        pedidosVisiveis.forEach((check) => (check.checked = false));
        btnSelecionarTodos.innerHTML =
          '<i class="fas fa-check-square me-1"></i>Selecionar Todos';
      }

      atualizarCheckTodos();
      atualizarBotaoExecutar();
    });

    // Mudan√ßa na a√ß√£o selecionada
    acaoSelect.addEventListener("change", function () {
      const acao = this.value;

      if (acao === "mover_grupo") {
        grupoDestinoDiv.style.display = "block";
        grupoDestinoSelect.required = true;
      } else {
        grupoDestinoDiv.style.display = "none";
        grupoDestinoSelect.required = false;
      }

      atualizarBotaoExecutar();
    });

    // Confirma√ß√£o antes de executar a√ß√£o
    formAcoesLote.addEventListener("submit", function (e) {
      const acao = acaoSelect.value;
      const pedidosSelecionados = document.querySelectorAll(
        ".check-pedido:checked"
      );

      if (pedidosSelecionados.length === 0) {
        e.preventDefault();
        alert("Selecione pelo menos um pedido!");
        return;
      }

      let mensagem = "";
      switch (acao) {
        case "excluir":
          mensagem = `Tem certeza que deseja excluir ${pedidosSelecionados.length} pedido(s)?`;
          break;
        case "remover_grupos":
          mensagem = `Tem certeza que deseja remover ${pedidosSelecionados.length} pedido(s) de seus grupos?`;
          break;
        case "mover_grupo":
          const grupoNome =
            grupoDestinoSelect.options[grupoDestinoSelect.selectedIndex].text;
          mensagem = `Tem certeza que deseja mover ${pedidosSelecionados.length} pedido(s) para ${grupoNome}?`;
          break;
      }

      if (!confirm(mensagem)) {
        e.preventDefault();
      }
    });

    // Fun√ß√µes auxiliares
    function atualizarCheckTodos() {
      const pedidosVisiveis = Array.from(checksPedidos).filter(
        (check) => check.closest("tr").style.display !== "none"
      );
      const pedidosSelecionados = pedidosVisiveis.filter(
        (check) => check.checked
      );

      if (pedidosSelecionados.length === 0) {
        checkTodos.checked = false;
        checkTodos.indeterminate = false;
      } else if (pedidosSelecionados.length === pedidosVisiveis.length) {
        checkTodos.checked = true;
        checkTodos.indeterminate = false;
      } else {
        checkTodos.checked = false;
        checkTodos.indeterminate = true;
      }
    }

    function atualizarBotaoExecutar() {
      const pedidosSelecionados = document.querySelectorAll(
        ".check-pedido:checked"
      );
      const acao = acaoSelect.value;

      if (pedidosSelecionados.length > 0 && acao) {
        btnExecutarAcao.disabled = false;

        // Atualizar texto do bot√£o
        let texto = "";
        switch (acao) {
          case "excluir":
            texto = `üóëÔ∏è Excluir ${pedidosSelecionados.length} Pedido(s)`;
            break;
          case "remover_grupos":
            texto = `‚ùå Remover ${pedidosSelecionados.length} de Grupo(s)`;
            break;
          case "mover_grupo":
            texto = `üì¶ Mover ${pedidosSelecionados.length} para Grupo`;
            break;
        }
        btnExecutarAcao.innerHTML = `<i class="fas fa-play me-1"></i>${texto}`;
      } else {
        btnExecutarAcao.disabled = true;
        btnExecutarAcao.innerHTML =
          '<i class="fas fa-play me-1"></i>Executar A√ß√£o';
      }
    }
  });
</script>
{% endblock %}
